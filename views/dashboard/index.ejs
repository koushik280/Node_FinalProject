<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">Dashboard</h4>
</div>

<% if (!data) { %>
  <div class="alert alert-danger">Could not load dashboard.</div>
<% } else { %>

  <!-- Top KPI cards -->
  <div class="row g-3 mb-3">
    <div class="col-sm-6 col-lg-3">
      <div class="card shadow-sm"><div class="card-body">
        <div class="text-muted small">Users</div>
        <div class="fs-3 fw-semibold"><%= data.totals?.users ?? 0 %></div>
      </div></div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card shadow-sm"><div class="card-body">
        <div class="text-muted small">Projects</div>
        <div class="fs-3 fw-semibold"><%= data.totals?.projects ?? 0 %></div>
      </div></div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card shadow-sm"><div class="card-body">
        <div class="text-muted small">Tasks</div>
        <div class="fs-3 fw-semibold"><%= data.totals?.tasks ?? 0 %></div>
      </div></div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card shadow-sm"><div class="card-body">
        <div class="text-muted small">Due (7 days)</div>
        <div class="fs-3 fw-semibold"><%= data.totals?.dueSoon ?? 0 %></div>
      </div></div>
    </div>
  </div>

  <!-- Charts -->
  <div class="row g-3">
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Users by Role</h6>
          </div>
          <!-- fixed-height container so Chart.js has space -->
          <div style="height:300px">
            <canvas id="usersByRole"></canvas>
          </div>
          <div id="usersByRoleEmpty" class="text-muted small d-none">No data</div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Tasks by Status</h6>
          </div>
          <div style="height:300px">
            <canvas id="tasksByStatus"></canvas>
          </div>
          <div id="tasksByStatusEmpty" class="text-muted small d-none">No data</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Page script -->
  <script>
  (function(){
    // data injected from SSR
    const payload = <%- JSON.stringify(data || {}) %>;
    const usersByRole   = payload.usersByRole   || [];
    const tasksByStatus = payload.tasksByStatus || [];
    const hasData = arr => Array.isArray(arr) && arr.length > 0;

    // Users by Role (doughnut)
    (function(){
      const el = document.getElementById('usersByRole');
      const empty = document.getElementById('usersByRoleEmpty');
      if (!hasData(usersByRole)) { el.classList.add('d-none'); empty.classList.remove('d-none'); return; }
      const labels = usersByRole.map(x => x.role);
      const values = usersByRole.map(x => x.count);
      new Chart(el.getContext('2d'), {
        type: 'doughnut',
        data: { labels, datasets: [{ data: values }] },
        options: {
          plugins: { legend: { position: 'bottom' } },
          maintainAspectRatio: false
        }
      });
    })();

    // Tasks by Status (bar)
    (function(){
      const el = document.getElementById('tasksByStatus');
      const empty = document.getElementById('tasksByStatusEmpty');
      if (!hasData(tasksByStatus)) { el.classList.add('d-none'); empty.classList.remove('d-none'); return; }
      const labels = tasksByStatus.map(x => x.status);
      const values = tasksByStatus.map(x => x.count);
      new Chart(el.getContext('2d'), {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Tasks', data: values }] },
        options: {
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
          maintainAspectRatio: false
        }
      });
    })();
  })();
  </script>
<% } %>
