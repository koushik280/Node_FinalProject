<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Ask TeamBoard Bot</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body { font-family: Inter, sans-serif; background: #f8fafc; }
    .chat-box {
      max-width: 700px;
      margin: 20px auto;
      background: white;
      border-radius: 10px;
      padding: 15px;
      height: 70vh;
      display: flex;
      flex-direction: column;
      border: 1px solid #e5e7eb;
    }
    .messages {
      flex: 1;
      overflow-y: auto;
      padding-right: 5px;
    }
    .msg {
      margin-bottom: 10px;
      max-width: 80%;
      word-wrap: break-word;
    }
    .msg.user { margin-left: auto; text-align: right; }
    .msg.user div { background: #2563eb; color: white; }
    .msg.bot div { background: #e2e8f0; color: #1e293b; }
    .msg div { padding: 8px 12px; border-radius: 10px; }
  </style>
</head>

<body>
  <div class="chat-box shadow">
    <h5 class="mb-3 text-center">Ask TeamBoard Bot</h5>

    <div id="messages" class="messages"></div>

    <form id="chatForm" class="d-flex gap-2">
      <input id="text" class="form-control" placeholder="Ask: how to login, how projects work..." />
      <button class="btn btn-primary">Send</button>
    </form>
  </div>

  <script src="/socket.io/socket.io.js"></script>
<script>
  // Connect as guest (no AT needed)
  const socket = io({ withCredentials: true });

  const msgBox = document.getElementById('messages');
  const form = document.getElementById('chatForm');
  const input = document.getElementById('text');

  function addMsg(text, who = 'bot') {
    const el = document.createElement('div');
    el.className = 'msg ' + who;
    el.innerHTML = `<div>${text}</div>`;
    msgBox.appendChild(el);
    msgBox.scrollTop = msgBox.scrollHeight;
  }

  // initial greeting
  addMsg("Hi ðŸ‘‹ I'm TeamBoard bot. Ask me anything about using this system!");

  // receive replies from server
  socket.on('chat:guest:reply', (payload) => {
    const reply = (payload && (payload.text || payload.reply || payload.message)) || 'Sorry, I could not respond.';
    addMsg(reply, 'bot');

    // optionally render structured tasks returned by bot
    if (payload && Array.isArray(payload.tasks) && payload.tasks.length) {
      addMsg(`(Bot returned ${payload.tasks.length} tasks â€” open app to manage)`);
    }
  });

  form.addEventListener('submit', function(e){
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;

    addMsg(text, 'user');
    input.value = '';

    // Emit a guest chat event to the server
    socket.emit('chat:guest', { text, room: 'global' });
  });

  socket.on('connect', () => console.debug('guest socket connected', socket.id));
  socket.on('disconnect', () => console.debug('guest socket disconnected'));
</script>

</body>
</html>
