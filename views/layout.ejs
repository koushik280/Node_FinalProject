<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>TeamBoard</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link href="/css/app.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="bg-body-tertiary">
    <div class="d-flex">
      <%- include('partials/sidebar') %>
      <div class="flex-grow-1 min-vh-100 d-flex flex-column">
        <%- include('partials/topbar') %>
        <main class="container-fluid py-3 flex-grow-1">
          <%- include('partials/flash') %> <%- body %>
        </main>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

    <script>
      $(function () {
        $("table[data-dt]").each(function () {
          if ($.fn.dataTable.isDataTable(this)) return;
          const $t = $(this);
          const noSort = ($t.data("dtNosort") || "")
            .toString()
            .split(",")
            .filter(Boolean)
            .map(Number);
          $t.DataTable({
            pageLength: parseInt($t.data("dtLength"), 10) || 10,
            order: [[0, "asc"]],
            columnDefs: noSort.length
              ? [{ targets: noSort, orderable: false }]
              : [],
          });
        });
      });
    </script>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      (function () {
        // guard
        if (typeof io === 'undefined') return;

        // Expose a single global socket connection
        window.appSocket = io({ withCredentials: true });

        // Handy helpers to join rooms from any page
        window.joinProjectRoom = function (projectId) {
          try { window.appSocket.emit('join', `project:${projectId}`); } catch {}
        };
        window.joinUserRoom = function (userId) {
          try { window.appSocket.emit('join', `user:${userId}`); } catch {}
        };

        // Automatically join the user's personal room if logged in
        <% if (locals.user && locals.user.id) { %>
          window.joinUserRoom('<%= locals.user.id %>');
        <% } %>

        // Minimal toast system (Bootstrap)
        window.pushToast = function (title, body) {
          const wrap = document.getElementById('toastWrap') || (function(){
            const d = document.createElement('div');
            d.id = 'toastWrap';
            d.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(d);
            return d;
          })();

          const el = document.createElement('div');
          el.className = 'toast';
          el.innerHTML = `
            <div class="toast-header">
              <strong class="me-auto">${title || 'Notification'}</strong>
              <small>now</small>
              <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">${body || ''}</div>
          `;
          wrap.appendChild(el);
          const t = new bootstrap.Toast(el, { delay: 4000 });
          t.show();
        };

        // Optional: global listeners for personal notifications
        window.appSocket.on('task:assigned_to_you', (e) => {
          window.pushToast('New Task Assigned', e?.title || 'A task was assigned to you');
        });
        window.appSocket.on('task:your_task_status_changed', (e) => {
          window.pushToast('Task Status Updated', `${e?.title || 'Task'} â†’ ${e?.status}`);
        });
      })();
    </script>
  </body>
</html>
