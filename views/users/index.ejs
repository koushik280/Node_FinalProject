<div class="d-flex justify-content-between align-items-center mb-3">
  <h4>Users</h4>
  <% if (locals.user && locals.user.role === 'superadmin') { %>
    <a href="/users/create" class="btn btn-primary">Create User</a>
  <% } %>
</div>

<div class="table-responsive bg-white shadow-sm rounded p-2">
  <table class="table table-sm align-middle" id="usersTbl" data-dt>
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Role</th>
        <th>Verified</th>
        <th>Actions</th>
      </tr>
    </thead>

    <tbody>
      <% users.forEach(u => {
           const currentRole = u.role?.name || '';
           const isMe = String(u._id) === String(locals.user?.id);
           const options = ['employee','manager','admin']; // visible options
      %>
        <tr>
          <td><%= u.name %></td>
          <td><%= u.email %></td>
          <td>
            <span class="badge bg-light border text-body"><%= currentRole %></span>
          </td>
          <td><%= u.isVerified ? 'Yes' : 'No' %></td>

          <td class="d-flex flex-wrap gap-2">
            <% if (locals.user?.role === 'superadmin') { %>
              <!-- Change role -->
              <form method="POST" action="/users/<%= u._id %>/role" class="d-flex gap-2 align-items-center">
                <select name="roleName" class="form-select form-select-sm w-auto" <%= isMe ? 'disabled' : '' %>>
                  <% options.forEach(r => { %>
                    <option value="<%= r %>" <%= r === currentRole ? 'selected' : '' %>><%= r %></option>
                  <% }) %>
                </select>
                <button class="btn btn-sm btn-outline-primary" <%= isMe ? 'disabled' : '' %>>
                  Update
                </button>
              </form>

              <!-- Delete user -->
              <form method="POST"
                    action="/users/<%= u._id %>/delete"
                    onsubmit="return confirm('Delete this user?');">
                <button class="btn btn-sm btn-outline-danger" <%= isMe ? 'disabled' : '' %>>
                  Delete
                </button>
              </form>
            <% } else { %>
              <span class="text-muted small">â€”</span>
            <% } %>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>
