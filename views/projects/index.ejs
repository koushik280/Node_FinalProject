<div class="d-flex justify-content-between align-items-center mb-3">
  <h4>Projects</h4>
  <% if (locals.user && (locals.user.role === 'admin' || locals.user.role ===
  'superadmin')) { %>
  <a href="/projects/create" class="btn btn-primary">Create Project</a>
  <% } %>
</div>

<!-- ðŸ” Search -->
<div class="mb-3">
  <input
    type="text"
    id="projectSearch"
    class="form-control"
    placeholder="Search projects..."
  />
</div>

<!-- âœ… give the list an id -->
<div class="list-group shadow-sm" id="projectList">
  <% (projects || []).forEach(p => { const searchText = ((p.name || '') + ' ' +
  (p.description || '')).toLowerCase(); %>

  <!-- âœ… add .project-item and a precomputed data-search for reliable matching -->
  <div
    class="list-group-item py-3 project-item"
    data-search="<%= searchText %>"
  >
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <!-- âœ… add .project-name and .project-desc -->
        <div class="fw-semibold project-name">
          <a href="/projects/<%= p._id %>" class="text-decoration-none"
            ><%= p.name %></a
          >
        </div>
        <div class="text-muted small project-desc">
          <%= p.description || '' %>
        </div>
      </div>

      <div class="d-flex gap-2">
        <a
          href="/projects/<%= p._id %>/tasks"
          class="btn btn-sm btn-outline-secondary"
          >Tasks</a
        >
        <a
          href="/projects/<%= p._id %>/members"
          class="btn btn-sm btn-secondary"
          >Members</a
        >

        <a
          href="/projects/<%= p._id %>/add_members"
          class="btn btn-sm btn-secondary"
          >Add Members</a
        >

        <% if (locals.user && (locals.user.role === 'admin' || locals.user.role
        === 'superadmin')) { %>
        <form
          method="POST"
          action="/projects/<%= p._id %>/delete"
          onsubmit="return confirm('Delete this project?');"
        >
          <button class="btn btn-sm btn-outline-danger">Delete</button>
        </form>
        <% } %>
      </div>
    </div>
  </div>
  <% }) %>
</div>

<script>
  (function () {
    const input = document.getElementById("projectSearch");
    const list = document.getElementById("projectList");
    if (!input || !list) return;

    const items = Array.from(list.querySelectorAll(".project-item"));

    function filterProjects() {
      const term = (input.value || "").toLowerCase().trim();
      let visible = 0;

      for (const el of items) {
        // âœ… use precomputed attribute for fast, reliable search
        const hay = el.getAttribute("data-search") || "";
        const show = !term || hay.includes(term);
        el.classList.toggle("d-none", !show);
        if (show) visible++;
      }

      // optional "no results" row
      let empty = document.getElementById("noResultsRow");
      if (!empty) {
        empty = document.createElement("div");
        empty.id = "noResultsRow";
        empty.className = "list-group-item text-muted text-center d-none";
        empty.textContent = "No matching projects";
        list.appendChild(empty);
      }
      empty.classList.toggle("d-none", visible !== 0);
    }

    input.addEventListener("input", filterProjects);
    filterProjects(); // initial
  })();
</script>
